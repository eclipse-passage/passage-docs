<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html>
<head>
    <title>Developer's guide</title>
    <script type="text/javascript" src="js/sh_main.min.js" language="JavaScript"></script>
    <script type="text/javascript" src="js/lang/sh_java.min.js" language="JavaScript"></script>
    <script type="text/javascript" src="js/lang/sh_xml.min.js" language="JavaScript"></script>
    <script type="text/javascript" src="js/lang/sh_properties.min.js" language="JavaScript"></script>
    <link href="css/sh_whitengrey.min.css" rel="stylesheet" type="text/css" media="all"/>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Quicksand&display=swap" rel="stylesheet">
    <link href="css/docs.css" rel="stylesheet" type="text/css" media="all"/>
</head>

<body onload="sh_highlightDocument();">
<div>
    Integrate Passage in your product's codebase.
</div>
<h1>Step 1: Tell Passage, what it must protect: declare licensing requirements</h1>
<div>
    <ul>
        <li>
            Highlight <span class="term">features</span> in your product that you want to be used under licensing
            protection.
            <p class="note">
                If the product itself must be protected - this is the first feature named
                after the product. If there are other functionality, like, say, especially clever graphical editor or
                <span class="sample">contact support team</span> function, these are features too.
            </p>
        </li>
        <li> Specify a feature for Passage.
            <ul>
                <li><span class="term">Name</span> each feature in a product-wide unique way.</li>
                <li>A feature, most probably, is going to evolve, so pinpoint a particular <span
                        class="term">version</span> for each
                    feature.
                </li>
                <li>Decide, how badly you want this feature to be protected by license.
                    We call it <span class="term">restriction level</span>.
                    It describes class of actions to be taken in case there is no proper license for the feature.
                    Currently four of them are supported:
                    <ul>
                        <li><span class="term">error</span>: lack of license coverage prevents feature from running: no
                            one must use
                            you feature without proper license
                        </li>
                        <li><span class="term">fatal</span>: the whole product is to be stopped, if this particular
                            feature is not
                            covered by a license
                        </li>
                        <li><span class="term">warn</span>: feature execution is to be paused and a user is forced to
                            take an action
                            to proceed (see an ad, press any key, etc.)
                        </li>
                        <li><span class="term">info</span>: light, not blocking informative action is to be taken, like
                            log entry
                            <span class="sample">the feature is not licensed</span>.
                        </li>
                    </ul>
                    <p class="note">Almost each of these actions are to be implemented on the product side. </p>
                </li>
            </ul>
        </li>
        <li>
            Demand licensing: declare <span class="term">licensing requirements</span> using <span class="term">Provide-Capability</span>
            header
            in a bundle's
            <span class="term">MANIFEST.MF</span>:
            <pre class="sh_properties">
 Provide-Capability: licensing.feature;licensing.feature="my.company.product.support";version="1.4.8";name="Contact Support Team";level="error";provider="The Company"
            </pre>
            Here is an example taken from <a target="_blank"
                                             href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.loc.api/META-INF/MANIFEST.MF">Passage
            Operator</a> licensing declaration:
            <pre class="sh_properties">
 Provide-Capability: licensing.feature;licensing.feature="org.eclipse.passage.loc.operator.issue.personal";version="2.0.0";name="Issue Personal License";level="warn";provider="Eclipse Passage",
   licensing.feature;licensing.feature="org.eclipse.passage.loc.operator.issue.floating";version="2.0.0";name="Issue Floating License";level="warn";provider="Eclipse Passage",
   licensing.feature;licensing.feature="org.eclipse.passage.loc.operator.issue.personal.full";version="2.0.0";name="Issue full functioning Personal License";level="error";provider="Eclipse Passage",
   licensing.feature;licensing.feature="org.eclipse.passage.loc.operator.issue.floating.full";version="2.0.0";name="Issue full functioning Floating License";level="error";provider="Eclipse Passage"
            </pre>
            <p class="note"> Passage does not make any difference between your bundles, your licensing requirements will
                be located anyway. But it's a good practice to declare licensing requirements as a part of functionality
                contract, in a sort of <span class="sample">API</span> bundle for the corresponding functionality.
            </p>
        </li>
    </ul>
    <p>Now Passage knows exactly what parts of your product is to be protected and which licenses are proper.</p>
</div>
<h1>Step 2: Tell Passage, which services it has: configure Access Cycle</h1>
<div>
    <p><span class="term">Access Cycle</span> is an invisible part of Passage that facilitates license checks on you
        product's runtime. </p>
    <p>It is highly configurable, though the configuration is quite simple:
        your product's codebase just need to supply an instance of <a target="_blank"
                                                                      href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.api/src/org/eclipse/passage/lic/internal/api/Framework.java">Framework</a>
        interface
        available through OSGi-component implementing <a target="_blank"
                                                         href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.api/src/org/eclipse/passage/lic/internal/api/FrameworkSupplier.java">FrameworkSupplier</a>
        interface </p>
    <p class="note">
        We have <a target="_blank"
                   href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.seal.demo/src/org/eclipse/passage/seal/internal/demo/DemoFramework.java">Demo
        Framework</a>,
        which is configured with all the services implementations we have out of the box.
        You can also consult with the <a target="_blank"
                                         href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.loc.operator.seal/src/org/eclipse/passage/loc/operator/seal/OperatorFramework.java">Operator
        Framework</a>, which configures Access Cycle for our
        <a target="_blank" href="https://download.eclipse.org/passage/downloads/release/1.2.1/operator/">Passage
            Operator</a> product.
    </p>
    <p>There must be exactly one <span class="term">Framework</span> supplied on runtime, other configurations are
        treated by Passage as sabotage.</p>
</div>
<h1>Step 3: Implant license checks</h1>
<div>
    <p>Now in all key places in the product's codebase you should check if there is sufficient license coverage and take
        proper actions it there isn't.</p>
    <p>
        Each feature, been used, must <span class="term">acquire a license grant</span> and then <span
            class="term">release</span> it after the work is done.
    </p>
    <p>The only piece of data you need to communicate with <span class="term">Passage Access Cycle</span> is identifier
        for a <span class="term">feature</span> you declared to protect.
    </p>
    <p> There are two main interfaces, which facilitate license checks for client code:
        <a target="_blank"
           href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.api/src/org/eclipse/passage/lic/internal/api/Passage.java">Passage</a>
        and
        <a target="_blank"
           href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.api/src/org/eclipse/passage/lic/internal/api/PassageUI.java">Passage
            UI</a> interfaces
        with <span class="term">Equinox</span>-based implementations
        <a target="_blank"
           href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.equinox/src/org/eclipse/passage/lic/internal/equinox/EquinoxPassage.java">Equinox
            Passage</a>
        and <a target="_blank"
               href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.jface/src/org/eclipse/passage/lic/internal/jface/EquinoxPassageUI.java">Equinox
            Passage UI</a>.
    </p>
    <div>
        <p>
            Simply put, the you should cover the feature invocation into <span class="term">acquire-release</span> pair
            of appeals to Passage Access Cycle. Generally it looks like this:
        </p>
        <pre class="sh_java">
            String feature = "my.feature.identifier";
            ...
            public void protectedFunctionalityIsRequested(){
                ServiceInvocationResult&lt;GrantLockAttempt&gt; grant = new EquinoxPassage().acquireLicense(feature);
                if(grantIsNotAcquired(grant)) {
                    handleFailure(grant.diagnostic());
                    return;
                }
                keepGrant(grant.data());
                invokeProtectedFunctionality();
            }

            ...
            void protectedFunctionalityCompletedOrFailed() {
                grant.ifPresent(new EquinoxPassage()::releaseLicense);
            }
        </pre>
        <p>
            To avoid boilerplating this template among client's code, Passage supplies couple of handy units:
        </p>
        <ul>
            <li>
                <a target="_blank"
                   href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.equinox/src/org/eclipse/passage/lic/internal/equinox/LicensedRunnable.java">Licensed
                    Runnable</a>
                - use it's <span class="term">Default</span> implementation or extend to cover usage of a headless
                feature under licensing protection.
            </li>
            <li>
                <a target="_blank"
                   href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.jface/src/org/eclipse/passage/lic/internal/jface/actions/LicensedRunnableUi.java">License
                    Runnable UI</a>
                or <a target="_blank"
                      href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.jface/src/org/eclipse/passage/lic/internal/jface/actions/LicensedAction.java">Licensed
                Action</a>
                - for the same purpose, but for features that can afford GUI invocation.
            </li>
        </ul>
    </div>
    <p>Let's solve a pair of practical tasks</p>
    <table class="tasks">
        <tr>
            <td class="task">
                <p>check license of the product's start</p>
            </td>
            <td class="solution">
               <p>Having you've declared a licensing requirement for feature named after the product, use
                <a target="_blank"
                   href="https://github.com/eclipse-passage/passage/blob/master/bundles/org.eclipse.passage.lic.e4.ui/src/org/eclipse/passage/lic/internal/e4/ui/addons/E4LicensingAddon.java">Passage
                    Licensing Addon</a>. It can be activated with the use of extension:</p>
                <pre class="sh_xml">
        &lt;extension
                id="licensing"
                point="org.eclipse.e4.workbench.model"&gt;
              &lt;processor
                      apply="always"
                      beforefragment="false"
                      class="org.eclipse.passage.lic.internal.e4.ui.addons.E4LicensingProcessor"&gt;
              &lt;/processor&gt;
        &lt;/extension&gt;
            </pre>
                <p>In case of insufficient license it'll expose standard Passage <span
                        class="term">Licensing status dialog</span> like it does for Passage Operator:
                </p>
                <img class="built-in" src="i/passage-ui-product-startup.PNG" width="380px"/>
            </td>
        </tr>
        <tr>
            <td class="task">
                <p>enable/disable GUI item depending on whether it's functionality is covered by a license or not</p>
            </td>
            <td class="solution">
                <p>You can <span class="sample">just aks</span> Passage if the feature can potentially be used:
                    no grant is to be acquired, so do not use the check for the final functionality protection.
                </p>
                <pre class="sh_java">
        public final class ProtectedAction extends org.eclipse.jface.action.Action {
            private final String feature = "my.protected.feature.identifier";
            ...
            @Override
            public boolean isEnabled() {
                return new EquinoxPassage().canUse(feature);
            }
            ...
        }
                </pre>
            </td>
        </tr>
        <tr>
            <td class="task">
                <p>protect headless action</p>
            </td>
            <td class="solution">

            </td>
        </tr>
        <tr>
            <td class="task">
                <p>protect action with GUI available</p>
            </td>
            <td class="solution">

            </td>
        </tr>
        <tr>
            <td class="task">
                <p>handle <span class="sample">not covered by a license</span> case</p>
            </td>
            <td class="solution">

            </td>
        </tr>

    </table>
</div>

</body>
</html>